#!/bin/sh
# Enhanced pre-commit hook with performance optimization and better UX

echo "ğŸ” Starting pre-commit checks..."
start_time=$(date +%s)

# Function to run checks with timing
run_check() {
  local name="$1"
  local command="$2"
  local emoji="$3"
  
  echo "${emoji} ${name}..."
  local check_start=$(date +%s)
  
  if eval "$command"; then
    local check_end=$(date +%s)
    local check_duration=$((check_end - check_start))
    echo "âœ… ${name} passed (${check_duration}s)"
  else
    echo "âŒ ${name} failed!"
    echo "ğŸ’¡ Tip: Run 'npm run ${command#npm run }' to debug"
    exit 1
  fi
}

# Parallel execution for independent checks
{
  run_check "Type checking" "npm run type-check" "ğŸ“"
} &
type_check_pid=$!

{
  run_check "Linting" "npm run lint" "ğŸ”§"
} &
lint_pid=$!

{
  run_check "Format checking" "npm run format:check" "ğŸ’„"
} &
format_pid=$!

# Wait for parallel jobs and check results
wait $type_check_pid
type_check_result=$?

wait $lint_pid
lint_result=$?

wait $format_pid
format_result=$?

# Check if any parallel job failed
if [ $type_check_result -ne 0 ] || [ $lint_result -ne 0 ] || [ $format_result -ne 0 ]; then
  echo "âŒ Some checks failed. Please fix the issues before committing."
  echo "ğŸ’¡ Quick fix: npm run format && npm run lint:fix"
  exit 1
fi

# Build test (sequential as it may depend on above checks)
run_check "Build testing" "npm run build" "ğŸ”¨"

# Calculate total time
end_time=$(date +%s)
total_duration=$((end_time - start_time))

echo ""
echo "ğŸ‰ All checks passed in ${total_duration}s! Ready to commit."
echo "ğŸ“Š Performance: Type check, lint, and format ran in parallel for faster execution."
